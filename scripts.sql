CREATE TABLE PDF_DOWNLOAD_DMS_CLAIMS (
    -- Primary key
    DOWNLOAD_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    
    -- File identification (from original DMS system)
    FILE_ID VARCHAR2(255) NOT NULL,
    CLAIM_ID NUMBER(20) NOT NULL,
    CLAIM_NO VARCHAR2(100),
    
    -- File information
    REMOTE_FILE_NAME VARCHAR2(255),
    LOCAL_FILE_PATH VARCHAR2(1000),
    FILE_SIZE_BYTES NUMBER,
    
    -- Download tracking
    DOWNLOAD_TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    STATUS VARCHAR2(20) DEFAULT 'PENDING' NOT NULL,
    ERROR_MESSAGE VARCHAR2(2000),
    
    -- Additional claim information for reporting
    VIN VARCHAR2(50),
    GROSS_CREDIT NUMBER(15,2),
    REPORT_DATE DATE,
    
    -- Audit fields
    CREATED_BY VARCHAR2(100) DEFAULT 'PDF_DOWNLOAD_SERVICE',
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LAST_MODIFIED_BY VARCHAR2(100),
    LAST_MODIFIED_DATE TIMESTAMP,
    
    -- Constraints
    CONSTRAINT CHK_PDF_STATUS CHECK (STATUS IN ('PENDING', 'SUCCESS', 'FAILED', 'RETRY')),
    CONSTRAINT UQ_PDF_FILE_ID UNIQUE (FILE_ID)
);

-- Create indexes for better performance
CREATE INDEX IDX_PDF_CLAIM_ID ON PDF_DOWNLOAD_DMS_CLAIMS (CLAIM_ID);
CREATE INDEX IDX_PDF_STATUS ON PDF_DOWNLOAD_DMS_CLAIMS (STATUS);
CREATE INDEX IDX_PDF_DOWNLOAD_DATE ON PDF_DOWNLOAD_DMS_CLAIMS (DOWNLOAD_TIMESTAMP);
CREATE INDEX IDX_PDF_REPORT_DATE ON PDF_DOWNLOAD_DMS_CLAIMS (REPORT_DATE);

-- 1. Create CLAIM_STATUS table
CREATE TABLE CLAIM_STATUS (
    -- Primary identification
    CLAIM_ID NUMBER(20) PRIMARY KEY,
    CLAIM_NO VARCHAR2(100),
    
    -- Vehicle and basic info
    VIN VARCHAR2(50),
    DEALER_CODE VARCHAR2(50),
    DEALER_NAME VARCHAR2(200),
    REPORT_DATE DATE,
    
    -- Financial amounts from DMS
    GROSS_CREDIT NUMBER(15,2),
    LABOUR_AMOUNT_DMS NUMBER(15,2),
    PART_AMOUNT_DMS NUMBER(15,2),
    
    -- File tracking
    TOTAL_FILES_COUNT NUMBER DEFAULT 0,
    DOWNLOADED_FILES_COUNT NUMBER DEFAULT 0,
    
    -- Date tracking for memoization
    LAST_DMS_UPDATE_DATE TIMESTAMP,
    AUDITING_DATE TIMESTAMP,
    
    -- Status tracking
    ATTACHMENT_STATUS VARCHAR2(20) DEFAULT 'PENDING', -- 'COMPLETE', 'PARTIAL', 'PENDING'
    AUDIT_STATUS VARCHAR2(20), -- 'COMPLETE', 'REJECTED', 'PENDING', NULL
    
    -- Audit fields
    CREATED_BY VARCHAR2(100) DEFAULT 'PDF_DOWNLOAD_SERVICE',
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LAST_MODIFIED_BY VARCHAR2(100) DEFAULT 'PDF_DOWNLOAD_SERVICE',
    LAST_MODIFIED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- Constraints
    CONSTRAINT CHK_CLAIM_ATTACHMENT_STATUS CHECK (ATTACHMENT_STATUS IN ('PENDING', 'PARTIAL', 'COMPLETE')),
    CONSTRAINT CHK_CLAIM_AUDIT_STATUS CHECK (AUDIT_STATUS IN ('PENDING', 'COMPLETE', 'REJECTED') OR AUDIT_STATUS IS NULL)
);

-- 2. Add indexes for CLAIM_STATUS table performance
CREATE INDEX IDX_CLAIM_STATUS_ATTACHMENT ON CLAIM_STATUS (ATTACHMENT_STATUS);
CREATE INDEX IDX_CLAIM_STATUS_AUDIT ON CLAIM_STATUS (AUDIT_STATUS);
CREATE INDEX IDX_CLAIM_STATUS_UPDATE_DATE ON CLAIM_STATUS (LAST_DMS_UPDATE_DATE);
CREATE INDEX IDX_CLAIM_STATUS_REPORT_DATE ON CLAIM_STATUS (REPORT_DATE);
CREATE INDEX IDX_CLAIM_STATUS_DEALER ON CLAIM_STATUS (DEALER_CODE);

-- 3. Alter PDF_DOWNLOAD_DMS_CLAIMS table to add new columns
ALTER TABLE PDF_DOWNLOAD_DMS_CLAIMS ADD (
    CLAIM_LAST_MODIFIED TIMESTAMP,
    IS_LATEST_VERSION CHAR(1) DEFAULT 'Y'
);

-- 4. Add constraint for IS_LATEST_VERSION
ALTER TABLE PDF_DOWNLOAD_DMS_CLAIMS ADD CONSTRAINT CHK_PDF_IS_LATEST_VERSION 
CHECK (IS_LATEST_VERSION IN ('Y', 'N'));

-- 5. Add indexes for new columns in PDF_DOWNLOAD_DMS_CLAIMS
CREATE INDEX IDX_PDF_LATEST_VERSION ON PDF_DOWNLOAD_DMS_CLAIMS (IS_LATEST_VERSION);
CREATE INDEX IDX_PDF_CLAIM_LAST_MODIFIED ON PDF_DOWNLOAD_DMS_CLAIMS (CLAIM_LAST_MODIFIED);

-- 6. Add index for better claim-based queries
CREATE INDEX IDX_PDF_CLAIM_STATUS ON PDF_DOWNLOAD_DMS_CLAIMS (CLAIM_ID, STATUS, IS_LATEST_VERSION);

-- 7. Create a view for easy monitoring of claim status
CREATE OR REPLACE VIEW V_CLAIM_DOWNLOAD_SUMMARY AS
SELECT 
    cs.CLAIM_ID,
    cs.CLAIM_NO,
    cs.VIN,
    cs.DEALER_CODE,
    cs.DEALER_NAME,
    cs.REPORT_DATE,
    cs.GROSS_CREDIT,
    cs.LABOUR_AMOUNT_DMS,
    cs.PART_AMOUNT_DMS,
    cs.TOTAL_FILES_COUNT,
    cs.DOWNLOADED_FILES_COUNT,
    cs.ATTACHMENT_STATUS,
    cs.AUDIT_STATUS,
    cs.LAST_DMS_UPDATE_DATE,
    cs.AUDITING_DATE,
    -- Calculate completion percentage
    CASE 
        WHEN cs.TOTAL_FILES_COUNT > 0 THEN 
            ROUND((cs.DOWNLOADED_FILES_COUNT / cs.TOTAL_FILES_COUNT) * 100, 2)
        ELSE 0 
    END AS DOWNLOAD_COMPLETION_PCT,
    -- Count of latest version files
    COUNT(CASE WHEN pdf.IS_LATEST_VERSION = 'Y' AND pdf.STATUS = 'SUCCESS' THEN 1 END) AS CURRENT_SUCCESS_FILES,
    COUNT(CASE WHEN pdf.IS_LATEST_VERSION = 'Y' AND pdf.STATUS = 'FAILED' THEN 1 END) AS CURRENT_FAILED_FILES,
    cs.CREATED_DATE,
    cs.LAST_MODIFIED_DATE
FROM 
    CLAIM_STATUS cs
LEFT JOIN 
    PDF_DOWNLOAD_DMS_CLAIMS pdf ON cs.CLAIM_ID = pdf.CLAIM_ID
GROUP BY 
    cs.CLAIM_ID, cs.CLAIM_NO, cs.VIN, cs.DEALER_CODE, cs.DEALER_NAME,
    cs.REPORT_DATE, cs.GROSS_CREDIT, cs.LABOUR_AMOUNT_DMS, cs.PART_AMOUNT_DMS,
    cs.TOTAL_FILES_COUNT, cs.DOWNLOADED_FILES_COUNT, cs.ATTACHMENT_STATUS,
    cs.AUDIT_STATUS, cs.LAST_DMS_UPDATE_DATE, cs.AUDITING_DATE,
    cs.CREATED_DATE, cs.LAST_MODIFIED_DATE;

